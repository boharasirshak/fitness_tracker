<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Fitness Tracker</title>
    <link
      rel="shortcut icon"
      href="{{ url_for('static', path='favicon.ico') }}"
      type="image/x-icon"
    />
    <link
      href="{{ url_for('static', path='/css/main.css') }}"
      rel="stylesheet"
    />
    <script src="{{ url_for('static', path='/js/lib.js') }}"></script>
    <script src="{{ url_for('static', path='/js/store.js') }}"></script>
  </head>
  <body>
    Dashboard
    <div id="user-data"> </div>

    <script>
      (async () => {
        let accessToken = localStorage.getItem("access_token");
        let refreshToken = localStorage.getItem("refresh_token");
        if (accessToken && refreshToken) {
          let isValid = await verifyJwtToken(accessToken);
          console.log(`Access token is: ${isValid ? "valid" : "invalid"}`);

          if (!isValid) {
            let { access_token, refresh_token } = await refreshJwtToken(
              refreshToken
            );

            if (access_token && refresh_token) {
              localStorage.setItem("access_token", access_token);
              localStorage.setItem("refresh_token", refresh_token);
            } else {
              console.log("Invalid refresh token.");
              window.location.href = "/login";
            }
          }
        } else {
          window.location.href = "/login";
        }

        let {res, data} = await getUser(accessToken);
        console.log(res, data);
        if (res.status === 401) {
          window.location.href = "/login";
        }

        // CASE: user has not set up their profile yet
        if (data.username === "") {
          window.location.href = "/profile";
        }

        document.getElementById("user-data").innerHTML = JSON.stringify(data, null, 2);

      })();
    </script> 
  </body>
</html>
