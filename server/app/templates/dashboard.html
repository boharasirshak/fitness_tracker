<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard | Fitness Tracker</title>
    <link
      rel="shortcut icon"
      href="{{ url_for('static', path='favicon.ico') }}"
      type="image/x-icon"
    />
    <link
      href="{{ url_for('static', path='/css/main.css') }}"
      rel="stylesheet"
    />
    <script src="{{ url_for('static', path='/js/lib.js') }}"></script>
  </head>
  <body>
    <script>
      (async () => {
        let accessToken = localStorage.getItem("access_token");
        let refreshToken = localStorage.getItem("refresh_token");
        if (accessToken && refreshToken) {
          let isValid = await verifyJwtToken(accessToken);
          console.log(`Access token is: ${isValid ? "valid" : "invalid"}`);

          if (isValid) {
            window.location.href = "/dashboard";
          } else {
            let { access_token, refresh_token } = await refreshJwtToken(
              refreshToken
            );

            if (access_token && refresh_token) {
              localStorage.setItem("access_token", access_token);
              localStorage.setItem("refresh_token", refresh_token);
              window.location.href = "/dashboard";
            } else {
              console.log("Invalid refresh token. Stay on the page.");
            }
          }
        }
      })();
    </script> 

    <script>
      (async () => {
        // *Technically* the token should not expire because we already validated that just above
        // but in some rare edge cases, the token might expire between the time we validated it and the time we use it
        // so, TODO: handle that edge case

        // let user = await getUser();

        // // CASE: the user has not set his nickname yet
        // if (user.username === "") {
            // use Nanny for the state management.
        // }
      })();
    </script>
    Dashboard
  </body>
</html>
